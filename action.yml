# Github action to create a preview for pullrequests
# Brand Boosting GmbH | David S√º√ülin
name: "Create Shopify Theme Preview"
description: "Create a Shopify Theme Preview"
branding:
  icon: shopping-cart
  color: green
inputs:
  shopify_flag_store:
    description: "Store URL, like your-store.myshopify.com"
    required: true
  shopify_cli_theme_token:
    description: "Password generated from Theme Access app"
    required: true
  github_token:
    description: "GitHub token for managing PR labels"
    required: true
  build_step:
    description: "Command used as build step"
    default: 'echo "No build step"'
    required: false
  dir:
    description: "Directory to preview."
    default: "."
    required: false
  timezone:
    description: "TZ identifier"
    required: false
    default: "UTC"

runs:
  using: "composite"
  steps:
    - name: Set timezone
      uses: szenius/set-timezone@v1.2
      with:
        timezoneLinux: ${{ inputs.timezone }}
    - name: Get Date # Get current date
      id: date
      shell: bash
      run: echo "date=$(date +'%d-%m-%Y ')" >> $GITHUB_OUTPUT
    - name: Get Time # Get current time
      id: time
      run: echo "time=$(date +'%H:%M:%S')" >> $GITHUB_OUTPUT
      shell: bash
    - name: Find Comment
      uses: peter-evans/find-comment@v3
      id: find-comment
      with:
        issue-number: ${{ github.event.issue.number || github.event.pull_request.number }}
        comment-author: "github-actions[bot]"
        body-includes: "Shopify Theme Preview"
    - name: Comment Loading # Create skeleton table and visualize loading state
      id: create-comment
      uses: peter-evans/create-or-update-comment@v3.1.0
      with:
        comment-id: ${{ steps.find-comment.outputs.comment-id }}
        issue-number: ${{ github.event.issue.number || github.event.pull_request.number }}
        body: |
          Shopify Theme Preview

          | Name | Status | Preview | Editor | Date | Time |
          | :--- | :----- | :------ | :------ | :------ | :----- |
          | ${{ inputs.shopify_flag_store }} | üîÑ Loading |  |  | ${{ steps.date.outputs.date }} | ${{ steps.time.outputs.time }}

          *created by Brand Boosting GmbH | PotatoBot* [View on GitHub Marketplace](https://github.com/marketplace/actions/create-shopify-theme-preview)
        edit-mode: replace
    - uses: actions/checkout@v4 # Action checkout@v4
    - name: Checkout Pull Request # Set the right branch for the commented PR
      run: gh pr checkout ${{ github.event.issue.number || github.event.pull_request.number }}
      env:
        GITHUB_TOKEN: ${{ github.token }}
      shell: bash
    - uses: actions/setup-node@v4 # Action setup-node@v4
      with:
        node-version-file: '.nvmrc'
        cache: 'npm'
        cache-dependency-path: '**/package-lock.json'
    - uses: ruby/setup-ruby@v1 # Action setup-ruby@v1
      with:
        ruby-version: 3.1
        bundler: "latest"
    - name: Install Shopify CLI
      run: npm install -g @shopify/cli@3.63.1 @shopify/theme@3.58.2
      shell: bash
    - name: Check Version
      run: shopify version
      shell: bash
    - name: Build step
      run: ${{ inputs.build_step }}
      shell: bash
    - name: Get existing theme ID from PR labels
      id: get-theme-id
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.github_token }}
      run: |
        PR_NUMBER="${{ github.event.issue.number || github.event.pull_request.number }}"
        
        # Get all labels from PR and find theme-id label
        THEME_LABEL=$(gh pr view "$PR_NUMBER" --json labels --jq '.labels[].name | select(startswith("theme-id:"))' 2>/dev/null || echo "")
        
        if [ -n "$THEME_LABEL" ]; then
          # Extract theme ID from label (format: theme-id:123456789)
          THEME_ID="${THEME_LABEL#theme-id:}"
          echo "Found existing theme ID: $THEME_ID"
          echo "theme_id=$THEME_ID" >> $GITHUB_OUTPUT
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "No existing theme ID found, will create new development theme"
          echo "exists=false" >> $GITHUB_OUTPUT
        fi
    - name: Create Preview Link # and safe the returned value in an output object
      id: link
      shell: bash
      env:
        # Store URL, like your-store.myshopify.com
        SHOPIFY_FLAG_STORE: ${{ inputs.shopify_flag_store }}
        # Password generated from Theme Access app
        SHOPIFY_CLI_THEME_TOKEN: ${{ inputs.shopify_cli_theme_token }}
      run: |
        echo 'JSON_RESPONSE<<EOF' >> $GITHUB_OUTPUT
        if [ "${{ steps.get-theme-id.outputs.exists }}" == "true" ]; then
          echo "Pushing to existing theme: ${{ steps.get-theme-id.outputs.theme_id }}"
          shopify theme push --json --theme ${{ steps.get-theme-id.outputs.theme_id }} --path ${{ inputs.dir }} >> $GITHUB_OUTPUT || true
        else
          echo "Creating new development theme"
          shopify theme push --json --development --path ${{ inputs.dir }} >> $GITHUB_OUTPUT || true
        fi
        echo 'EOF' >> $GITHUB_OUTPUT
    - name: Format Data # Safe output in a temporary txt file and extract the last line with requested links
      run: |
        echo '${{ steps.link.outputs.JSON_RESPONSE }}' > 'temp.txt'
        echo 'LINK<<DEL' >> $GITHUB_OUTPUT
        tail -n1 temp.txt >> $GITHUB_OUTPUT
        echo 'DEL' >> $GITHUB_OUTPUT
      id: temp
      shell: bash
    - name: Save theme ID to PR label
      if: ${{ steps.get-theme-id.outputs.exists != 'true' }}
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.github_token }}
      run: |
        PR_NUMBER="${{ github.event.issue.number || github.event.pull_request.number }}"
        THEME_ID=$(echo '${{ steps.temp.outputs.LINK }}' | jq -r '.theme.id' 2>/dev/null || echo "")
        
        if [ -n "$THEME_ID" ] && [ "$THEME_ID" != "null" ]; then
          echo "Saving theme ID $THEME_ID as label on PR #$PR_NUMBER"
          
          # Create label if it doesn't exist
          gh label create "theme-id:$THEME_ID" --description "Shopify theme preview ID" --color "1E90FF" 2>/dev/null || true
          
          # Add label to PR
          gh pr edit "$PR_NUMBER" --add-label "theme-id:$THEME_ID"
        else
          echo "Warning: Could not extract theme ID from response"
        fi
    - name: Comment Link # Override the loading comment from the start with the actual values and links
      uses: peter-evans/create-or-update-comment@v3.1.0
      with:
        comment-id: ${{ steps.create-comment.outputs.comment-id }}
        body: |
          Shopify Theme Preview

          | Name | Status | Preview | Editor | Date | Time |
          | :--- | :----- | :------ | :------ | :------ | :----- |
          | ${{ inputs.shopify_flag_store }} | ‚úÖ Ready | <a href="${{ fromJSON(steps.temp.outputs.LINK).theme.preview_url }}" target="_blank">Preview</a> | [Editor](${{ fromJSON(steps.temp.outputs.LINK).theme.editor_url }}) | ${{ steps.date.outputs.date }} | ${{ steps.time.outputs.time }}

          *created by Brand Boosting GmbH | PotatoBot* [View on GitHub Marketplace](https://github.com/marketplace/actions/create-shopify-theme-preview)
        reactions: hooray
        edit-mode: replace
    - name: Output Step Failed # Create skeleton table and visualize failed state
      if: ${{ failure() }}
      uses: peter-evans/create-or-update-comment@v3.1.0
      with:
        comment-id: ${{ steps.create-comment.outputs.comment-id }}
        issue-number: ${{ github.event.issue.number || github.event.pull_request.numberr }}
        body: |
          Shopify Theme Preview

          | Name | Status | Preview | Editor | Date | Time |
          | :--- | :----- | :------ | :------ | :------ | :----- |
          | ${{ inputs.shopify_flag_store }} | ‚ùå Failed |  |  | ${{ steps.date.outputs.date }} | ${{ steps.time.outputs.time }}

          ‚ùå 'Create Preview Link' failed ‚ùå

          Please check if the following `inputs` are set correctly:
          - `shopify_cli_theme_token` [(?)](https://shopify.dev/themes/tools/theme-access)
          - `shopify_flag_store` 

          *created by Brand Boosting GmbH | PotatoBot* <p style="float: right;">[View on GitHub Marketplace](https://github.com/marketplace/actions/create-shopify-theme-preview)</p>
        edit-mode: replace
